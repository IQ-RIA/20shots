// Generated by CoffeeScript 1.3.3

define(['j/core/base/View', 'text!j/view/user/login/LoginForm.tpl', 'j/core/utils'], function(View, tpl, utils) {
  return View.extend({
    el: '#inner-container',
    events: {
      'click #login-button': 'onLoginButtonClick',
      'click .social-link.vk': 'loginViaVk'
    },
    doRender: function() {
      return _.template(tpl, {
        welcome: J.t("Welcome to StudShara"),
        ssDescription: J.t("Studshara is a place, that helps you to earn money and improve your marks at university.\n<br/>\n<br/>\n<ul class=\"app-desc\">\n    <span>In Studshara you can</span>\n    <li>Download free laboratory, control, seminars, lections, and other stuff</li>\n    <li>Share your work with other</li>\n    <li>Earn money using knowlage received in the university</li>\n    <li>And much much more ...</li>\n</ul>"),
        passwordPlaceholder: J.t("Password"),
        logIn: J.t("Log In"),
        vkAppId: J.constants.VK_APP_ID,
        createAccount: J.t("Create Account"),
        socialLogIn: J.t("Log in via <a class='social-link vk'>Vkontakte</a>?")
      });
    },
    renderNotice: function(message) {
      return J.fire("error", message);
    },
    onLoginButtonClick: function(e) {
      var emailField, passwordField;
      e.preventDefault();
      emailField = $(".email", this.$el);
      passwordField = $("#password", this.$el);
      if (!utils.validation.email.test(emailField.val())) {
        return this.renderNotice("Email isn't correct");
      }
      if (passwordField.val().length < 6) {
        return this.renderNotice("Password should be more then 6 letters");
      }
      return $.post(J.links.user.login, {
        email: emailField.val(),
        password: passwordField.val()
      }).success(_.bind(function(response) {
        var result;
        result = null;
        try {
          result = $.parseJSON(response);
        } catch (e) {

        }
        if (!result) {
          return;
        }
        if (!result.success) {
          return this.renderNotice("Email or password isn't correct");
        }
        return J.fire('login.success', result.data[0]);
      }, this));
    },
    /*
                tries to login user via vkontakte-social network
                @returns {undefined}
    */

    loginViaVk: function(e) {
      e.preventDefault();
      return VK.Auth.login(this.onLoginResponse);
    },
    onLoginResponse: function(response) {
      var user;
      if (response.status !== "connected") {
        return;
      }
      user = response.session.user;
      return VK.api("isAppUser", {
        uid: user.id
      }, function(response) {
        if (response.response - 0 !== 1) {
          return;
        }
        user.firstName = user.first_name;
        user.lastName = user.last_name;
        user.vkId = user.id;
        return $.post(J.links.verify, {
          vkId: user.vkId
        }, _.bind(function(response) {
          if (response.success) {
            return J.fire("login.success", response.items[0]);
          } else {
            return VK.api("users.get", {
              uids: user.id,
              fields: "city, country, education"
            }, function(response) {
              response = response.response[0];
              user.country = response.country;
              user.city = response.city;
              user.university = response.university;
              user.faculty = response.faculty;
              return J.app.instance().getRouter("user").fastLogin(user);
            });
          }
        }, this), "json");
      });
    }
  });
});
